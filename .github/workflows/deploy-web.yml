name: Deploy Web App (Artifact)

on:
  push:
    branches: [ "main" ]
    paths:
      - "GrandLineCards-Web/**"
      - ".github/workflows/deploy-web.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, iconv, json, mbstring, pdo

      - name: Build Application
        working-directory: ./GrandLineCards-Web
        run: |
          # Install Backend
          composer install --no-progress --prefer-dist --optimize-autoloader --no-dev
          
          # Install Frontend
          npm ci
          npm run build
          
          # Archive for Deployment (Exclude dev files to fix "file changed" error and reduce size)
          tar -czf release.tar.gz \
            --exclude=release.tar.gz \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=tests \
            --exclude=storage/framework/cache \
            --exclude=storage/framework/views \
            . || [[ $? -eq 1 ]] # Allow exit code 1 (warnings) just in case

      - name: Upload Artifact to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "GrandLineCards-Web/release.tar.gz"
          target: "${{ secrets.VPS_DIR }}"
          strip_components: 1

      - name: Deploy & Activate
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd ${{ secrets.VPS_DIR }}
            
            echo "üì¶ Extracting Update..."
            tar -xzf release.tar.gz
            rm release.tar.gz
            
            echo "üóÑÔ∏è Running Migrations & Optimization..."
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan storage:link
            
            # Ensure permissions
            chmod -R 775 storage bootstrap/cache
            
            echo "‚úÖ Deployment Successful!"
